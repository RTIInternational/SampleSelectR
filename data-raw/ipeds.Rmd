---
title: "IPEDS Fall 2023"
output: github_document
---


```{r}
#| label: setup
#| include: FALSE
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#| label: load-packages

library(tidyverse)
library(tidylog)
```

# Read in data

Downloaded original files from [IPEDS Data Center](https://nces.ed.gov/ipeds/datacenter/DataFiles.aspx?year=2023&surveyNumber=-1&sid=4737d338-5121-4355-bb91-01ffa92243ef&rtid=7)

- 2023 - Institutional characteristics - Directory information - HD2023
- 2023 - Institutional characteristics -Response status for all survey components - FLAGS2023
- 2023 - Frequently used/Derived variables - Enrollments, retention rates and other selected enrollment indicators: Fall 2023 - DRVEF2023

```{r}
#| label: read-in
inst_char_in <- read_csv(here::here("data-raw", "IPEDS_2023", "hd2023.csv"))
fall_enroll_in <- read_csv(here::here("data-raw", "IPEDS_2023", "drvef2023.csv"))
flags_in <- read_csv(here::here("data-raw", "IPEDS_2023", "flags2023.csv"))
```


```{r}
#| label: clean-enroll

fall_enroll <- fall_enroll_in %>%
  select(UNITID, ENRTOT, EFUG, EFUG1ST, EFUGFT, EFGRAD, EFGRADFT)
```

```{r}
#| label: clean-admin

inst_char_slim <- inst_char_in %>%
  left_join(select(flags_in, UNITID, STAT_EF)) %>%
  filter(SECTOR != 0, CYACTIVE == 1, STAT_EF %in% c(1, 2, 4)) %>%
  select(UNITID, INSTNM, STABBR, FIPS, OBEREG, ICLEVEL, SECTOR, LOCALE, DEGGRANT, HLOFFER, STAT_EF)

inst_char_cb <- readxl::read_xlsx(here::here("data-raw", "IPEDS_2023", "hd2023.xlsx"), sheet = "Frequencies")

add_label <- function(var) {
  lu <- inst_char_cb %>%
    filter(varname == var)

  alphacode <- any(str_detect(str_to_upper(lu$codevalue) %>% str_flatten(), LETTERS))

  if (!alphacode) {
    lu <- lu %>%
      mutate(
        codevalue = as.numeric(codevalue),
        valuelabel = fct_reorder(valuelabel, codevalue)
      ) %>%
      select(codevalue, valuelabel)
  } else {
    lu <- lu %>%
      mutate(
        valuelabel = fct_reorder(valuelabel, codevalue)
      ) %>%
      select(codevalue, valuelabel)
  }


  jb <- "codevalue"
  names(jb) <- var

  outcol <- inst_char_slim %>%
    left_join(lu, by = jb) %>%
    mutate(valuelabel = fct_drop(valuelabel)) %>%
    select(valuelabel)

  names(outcol) <- var

  return(outcol)
}
options("tidylog.display" = list()) # turn off

var_desc <- inst_char_slim %>%
  select(OBEREG:HLOFFER) %>%
  names() %>%
  map(add_label) %>%
  list_cbind()
options("tidylog.display" = NULL) # turn on

inst_char_full <-
  inst_char_slim %>%
  select(-c(OBEREG:HLOFFER)) %>%
  cbind(var_desc) %>%
  as_tibble()
```


```{r}
#| label: join-dat



ipeds_2023_init <- inst_char_full %>%
  left_join(fall_enroll, by = "UNITID") %>%
  mutate(
    EnrollmentDataAvailable = !(is.na(ENRTOT)),
    # manual fix of non ASCII character
    INSTNM = case_when(
      UNITID == 430935 ~ "Colegio de Cinematografia Artes y Television",
      UNITID == 449135 ~ "Dewey University-Juana Diaz",
      TRUE ~ INSTNM
    )
  )

# Before and after rename
options("tidylog.display" = list()) # turn off
inst_char_full %>%
  filter(UNITID %in% c(430935, 449135)) %>%
  select(UNITID, INSTNM)
ipeds_2023_init %>%
  filter(UNITID %in% c(430935, 449135)) %>%
  select(UNITID, INSTNM)
options("tidylog.display" = NULL) # turn on

ipeds_2023_init %>% count(EnrollmentDataAvailable, STAT_EF)

ipeds <- ipeds_2023_init %>%
  select(-EnrollmentDataAvailable, -STAT_EF)
```


# Save data

```{r}
#| label: save-dat
#| message: false

skimr::skim(ipeds)
summary(ipeds)
glimpse(ipeds)

usethis::use_data(ipeds, overwrite = TRUE, compress = "xz")
```

# Sketch out data for documentation

```{r}
#| label: describe-dat

varlist_hd <- readxl::read_xlsx(here::here("data-raw", "IPEDS_2023", "hd2023.xlsx"), sheet = "varlist")
varlist_dr <- readxl::read_xlsx(here::here("data-raw", "IPEDS_2023", "drvef2023.xlsx"), sheet = "varlist")

varlist_all <- varlist_hd %>%
  bind_rows(varlist_dr) %>%
  distinct(varname, .keep_all = TRUE)

formatline <- glue::glue("#' @format A tibble with {nrow(ipeds)} rows and {ncol(ipeds)} columns:")

des <- lapply(ipeds, class) %>%
  as_tibble() %>%
  pivot_longer(everything(), names_to = "variable", values_to = "class") %>%
  left_join(varlist_all, by = c("variable" = "varname")) %>%
  mutate(
    Describe = str_c("#'   \\item{", variable, "}{", varTitle, " (", class, ")}")
  ) %>%
  pull(Describe)

str_view(formatline)
str_view(des)
```
